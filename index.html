<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lessie Bea Health CRM üíú</title>
  <style>
    :root{
      --primary:#7B4AE2;
      --accent:#BFA7F2;
      --bg:#F6F2FF;
      --text:#2E1A47;
      --muted: rgba(46,26,71,0.75);
      --border: rgba(46,26,71,0.18);
      --shadow: 0 6px 18px rgba(123, 74, 226, 0.15);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
    }

    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 14px;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    h1{
      margin:0;
      font-size: 26px;
      color: var(--primary);
    }

    .sub{
      margin:0;
      font-size: 13px;
      color: var(--muted);
    }

    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      background: rgba(191, 167, 242, 0.25);
      border: 1px solid rgba(123, 74, 226, 0.25);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text);
      white-space:nowrap;
    }

    .btn{
      background: var(--primary);
      color:#fff;
      border:none;
      border-radius: 12px;
      padding: 10px 14px;
      cursor:pointer;
      box-shadow: var(--shadow);
    }
    .btn.secondary{
      background: #2E1A47;
    }
    .btn.light{
      background: var(--accent);
      color: var(--text);
      box-shadow: none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background:#fff;
      border-radius:16px;
      padding:16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(123, 74, 226, 0.10);
    }

    h2{
      margin:0 0 10px 0;
      font-size: 18px;
      color: var(--primary);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }

    label{
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
    }

    input, textarea, select{
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      color: var(--text);
      background: #fff;
    }
    textarea{ min-height: 84px; resize: vertical; }

    .field{
      min-width: 220px;
      flex: 1;
    }

    .small{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.35;
    }

    .divider{
      height:1px;
      background: rgba(46,26,71,0.10);
      margin: 12px 0;
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 900px){
      .kpiGrid{ grid-template-columns: repeat(2, 1fr); }
    }

    .kpi{
      background: rgba(191, 167, 242, 0.22);
      border: 1px solid rgba(123, 74, 226, 0.22);
      border-radius: 14px;
      padding: 12px;
    }
    .kpi .k{
      font-size: 12px;
      color: var(--muted);
    }
    .kpi .v{
      font-size: 18px;
      font-weight: 800;
      margin-top: 6px;
      color: var(--text);
    }

    .scriptureBox{
      background: rgba(191, 167, 242, 0.20);
      border: 1px solid rgba(123, 74, 226, 0.25);
      border-radius: 14px;
      padding: 12px;
    }

    .scriptureText{
      font-size: 13px;
      line-height: 1.55;
      color: var(--text);
      white-space: pre-wrap;
    }

    .checkRow{
      display:flex;
      gap: 14px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .checkRow label{
      font-weight: 600;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .checkRow input[type="checkbox"]{
      width:auto;
      transform: scale(1.1);
      accent-color: var(--primary);
    }

    canvas{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(46,26,71,0.12);
      background: #fff;
    }

    .listItem{
      padding: 10px;
      border: 1px solid rgba(46,26,71,0.12);
      border-radius: 14px;
      margin-bottom: 10px;
      background: #fff;
    }
    .listItem .meta{
      font-size: 13px;
      font-weight: 800;
    }
    .listItem .note{
      margin-top: 6px;
      font-size: 13px;
      color: var(--text);
      font-style: italic;
      white-space: pre-wrap;
    }
    .listItem .actions{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }

    .center{
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .authCard{
      max-width: 560px;
      width:100%;
      background:#fff;
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(123, 74, 226, 0.10);
    }
    .authCard h1{ font-size: 22px; }
    .authHint{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
      margin-top: 8px;
    }

    .hidden{ display:none !important; }
    .error{
      margin-top: 10px;
      color: #9b1c1c;
      font-size: 13px;
      font-weight: 700;
      white-space: pre-wrap;
    }
    .ok{
      margin-top: 10px;
      color: #14532d;
      font-size: 13px;
      font-weight: 700;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<!-- AUTH SCREEN -->
<div id="authScreen" class="center">
  <div class="authCard">
    <div class="title">
      <h1>Lessie Bea Health CRM üíú</h1>
      <p class="sub">Private. Peaceful. Consistent.</p>
    </div>

    <div class="divider"></div>

    <div class="scriptureBox">
      <strong>Important</strong>
      <div class="small">
        This version uses <strong>Firebase Email/Password</strong> so your Health CRM syncs across all devices.
        Use a real email you can type on every device.
      </div>
    </div>

    <div class="divider"></div>

    <!-- Create Account -->
    <div id="setupBox">
      <h2>Create account (first time)</h2>
      <div class="row">
        <div class="field">
          <label>Email</label>
          <input id="setupUser" autocomplete="username" placeholder="you@email.com" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="setupPass" type="password" autocomplete="new-password" placeholder="Create a password (6+ chars)" />
        </div>
      </div>
      <button class="btn" onclick="createAccount()">Create Account</button>
      <div id="setupMsg" class="error"></div>
    </div>

    <div class="divider"></div>

    <!-- Login -->
    <div id="loginBox">
      <h2>Login</h2>
      <div class="row">
        <div class="field">
          <label>Email</label>
          <input id="loginUser" autocomplete="username" placeholder="you@email.com" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="loginPass" type="password" autocomplete="current-password" placeholder="Your password" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" onclick="login()">Login</button>
        <button class="btn secondary" onclick="resetLocalCache()">Reset Local Cache</button>
      </div>

      <p class="authHint">
        Reset Local Cache does <strong>not</strong> delete your Firebase account. It only clears cached data in this browser.
        If you forgot your password, you can reset it in Firebase Console (Authentication ‚Üí Users) or tell me and I‚Äôll add a ‚ÄúReset password‚Äù button.
      </p>
      <div id="loginMsg" class="error"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appScreen" class="hidden">
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Lessie Bea Health CRM üíú</h1>
        <p class="sub" id="goalSubtitle"></p>
      </div>
      <div class="topActions">
        <span class="pill" id="helloUser"></span>
        <button class="btn light" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- DASHBOARD KPIs -->
    <div class="card">
      <h2>Dashboard</h2>
      <div class="kpiGrid">
        <div class="kpi">
          <div class="k">Start ‚Üí Goal</div>
          <div class="v" id="kpiStartGoal">247 ‚Üí 175</div>
        </div>
        <div class="kpi">
          <div class="k">Latest Friday</div>
          <div class="v" id="kpiLatestFriday">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="k">Total Change</div>
          <div class="v" id="kpiTotalChange">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="k">Days Logged</div>
          <div class="v" id="kpiDaysLogged">0</div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- DAILY ANCHOR -->
      <div class="scriptureBox">
        <div class="row" style="align-items:center;">
          <div style="flex:1;">
            <strong>Daily Anchor ‚úùÔ∏è</strong>
            <div class="small">Read one verse. That counts.</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn light" onclick="showPsalm()">Psalm 23</button>
            <button class="btn light" onclick="showProverbs()">Proverbs 23</button>
            <button class="btn light" onclick="showProverbs31()">Proverbs 31</button>
          </div>
        </div>

        <div class="divider"></div>

        <div id="scriptureTitle" style="font-weight:800; margin-bottom:6px;">Psalm 23 (KJV)</div>
        <div id="scriptureText" class="scriptureText"></div>

        <div class="checkRow">
          <label><input type="checkbox" id="bibleRead"> Read Bible Today ‚úÖ</label>
        </div>
        <div class="small">Tip: If you check ‚ÄúRead Bible Today‚Äù, hit ‚ÄúSave Daily Check-In‚Äù so it syncs.</div>
      </div>

      <div class="divider"></div>

      <!-- Bible Reading Dates Log -->
      <div class="scriptureBox">
        <div class="row" style="align-items:center;">
          <div style="flex:1;">
            <strong>Bible Reading Dates üìñ</strong>
            <div class="small">Log dates you read your Bible (great for streaks + consistency).</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label>Date you read</label>
            <input type="date" id="bibleLogDate" />
          </div>
          <div class="field">
            <label>Optional note (chapter/what stood out)</label>
            <input id="bibleLogNote" placeholder="Example: Proverbs 31 ‚Äî strength & honour" />
          </div>
          <button class="btn" onclick="saveBibleLog()" style="height:42px;">Save Bible Date</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="pill" id="bibleStreakPill">Streak: ‚Äî</div>
          <div class="pill" id="bibleTotalPill">Total dates logged: ‚Äî</div>
        </div>

        <div class="divider"></div>

        <strong>Recent Bible Dates</strong>
        <div id="bibleDatesList" style="margin-top:10px;"></div>
      </div>
    </div>

    <div class="grid">
      <!-- DAILY CHECK-IN -->
      <div class="card">
        <h2>Daily Check-In (simple)</h2>

        <div class="row">
          <div class="field">
            <label>Date</label>
            <input type="date" id="dailyDate" />
          </div>
        </div>

        <div class="checkRow">
          <label><input type="checkbox" id="dailyWorkout"> Workout / Move ‚úÖ</label>
          <label><input type="checkbox" id="dailyFood"> Food On Plan ‚úÖ</label>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field">
            <label>Workout Done (type it)</label>
            <input id="dailyWorkoutText" placeholder="Example: 30 min walk + squats + bands" />
            <div class="small">This helps you see what worked later.</div>
          </div>

          <div class="field">
            <label>Calories (estimate)</label>
            <input id="dailyCalories" type="number" min="0" step="1" placeholder="Example: 1500" />
            <div class="small">Estimates are fine. Consistency matters most.</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label>Meals Today</label>
            <select id="dailyMeals">
              <option value="">Select‚Ä¶</option>
              <option value="OMAD">OMAD (1 meal)</option>
              <option value="2MAD">2MAD (2 meals)</option>
              <option value="3MAD">3MAD (3 meals)</option>
              <option value="MRE">MRE (multiple small meals)</option>
            </select>
          </div>

          <div class="field">
            <label>Water</label>
            <div class="checkRow" style="margin-top:6px;">
              <label><input type="checkbox" id="dailyWater40"> Drank more than 40 oz ‚úÖ</label>
            </div>
            <div class="small">Just yes/no. Keep it simple.</div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Short Journal (1‚Äì3 sentences)</label>
          <textarea id="dailyJournal" maxlength="250" placeholder="How did today feel? Keep it kind."></textarea>
          <div class="small">Short is the goal. No pressure.</div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="saveDaily()">Save Daily Check-In</button>
          <button class="btn light" onclick="clearDailyForm()">Clear Form</button>
        </div>

        <div id="dailyMsg" class="ok"></div>

        <div class="divider"></div>
        <strong>Recent Daily Check-Ins</strong>
        <div id="dailyList" style="margin-top:10px;"></div>
      </div>

      <!-- FRIDAY WEIGH-IN -->
      <div class="card">
        <h2>Friday Weigh-In ‚öñÔ∏è</h2>

        <div class="row">
          <div class="field">
            <label>Date (Friday)</label>
            <input type="date" id="fridayDate" />
          </div>
          <div class="field">
            <label>Weight</label>
            <input type="number" id="fridayWeight" placeholder="Enter weight" step="0.1" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Friday Reflection / Prayer (short)</label>
          <textarea id="fridayPrayer" maxlength="400" placeholder="Lord, help me stay consistent and peaceful. Thank You for strength this week."></textarea>
          <div class="small">This is your quiet reset, not homework.</div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="saveFridayWeighIn()">Save Weigh-In</button>
        </div>

        <div class="divider"></div>

        <div class="scriptureBox">
          <strong>Monthly Milestone</strong>
          <div id="milestoneText" style="margin-top:8px;"></div>
        </div>

        <div class="divider"></div>

        <strong>Progress Chart</strong>
        <canvas id="weighInChart" width="900" height="260"></canvas>
        <div id="chartHint" class="small"></div>

        <div class="divider"></div>

        <strong>Weigh-In History</strong>
        <div id="weighInList" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- üî• Firebase SDKs (COMPAT ‚Äì works with GitHub Pages) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
/* =======================
   FIREBASE INIT (SEPARATE PROJECT)
======================= */
const firebaseConfig = {
  apiKey: "AIzaSyAQ7Swd3ONHWYwHKxQEWvsE0sj_Xzv2AjE",
  authDomain: "lessie-bea-health-crm.firebaseapp.com",
  projectId: "lessie-bea-health-crm",
  storageBucket: "lessie-bea-health-crm.firebasestorage.app",
  messagingSenderId: "374888112294",
  appId: "1:374888112294:web:a29b9f92c3c56b0f0e9467"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let currentUid = null;

let unsubDaily = null;
let unsubWeigh = null;

/* =======================
   CONFIG / GOAL
======================= */
const GOAL = {
  startWeight: 247,
  targetWeight: 175,
  startDate: "2026-02-20",
  endDate: "2026-12-31"
};

/* =======================
   LOCAL CACHE KEYS (optional)
======================= */
const KEY_DAILY_CACHE    = "LBH_dailyLogs_cache_v3";
const KEY_WEIGHINS_CACHE = "LBH_fridayWeighIns_cache_v2";
const KEY_SCRIPTURE      = "LBH_scriptureChoice_v1";

/* =======================
   SCRIPTURES (KJV)
======================= */
const PSALM_23_KJV =
`1 The LORD is my shepherd; I shall not want.
2 He maketh me to lie down in green pastures: he leadeth me beside the still waters.
3 He restoreth my soul: he leadeth me in the paths of righteousness for his name's sake.
4 Yea, though I walk through the valley of the shadow of death, I will fear no evil: for thou art with me; thy rod and thy staff they comfort me.
5 Thou preparest a table before me in the presence of mine enemies: thou anointest my head with oil; my cup runneth over.
6 Surely goodness and mercy shall follow me all the days of my life: and I will dwell in the house of the LORD for ever.`;

const PROVERBS_23_KJV =
`1 When thou sittest to eat with a ruler, consider diligently what is before thee:
2 And put a knife to thy throat, if thou be a man given to appetite.
3 Be not desirous of his dainties: for they are deceitful meat.
4 Labour not to be rich: cease from thine own wisdom.
5 Wilt thou set thine eyes upon that which is not? for riches certainly make themselves wings; they fly away as an eagle toward heaven.
6 Eat thou not the bread of him that hath an evil eye, neither desire thou his dainty meats:
7 For as he thinketh in his heart, so is he: Eat and drink, saith he to thee; but his heart is not with thee.
8 The morsel which thou hast eaten shalt thou vomit up, and lose thy sweet words.
9 Speak not in the ears of a fool: for he will despise the wisdom of thy words.
10 Remove not the old landmark; and enter not into the fields of the fatherless:
11 For their redeemer is mighty; he shall plead their cause with thee.
12 Apply thine heart unto instruction, and thine ears to the words of knowledge.
13 Withhold not correction from the child: for if thou beatest him with the rod, he shall not die.
14 Thou shalt beatest him with the rod, and shalt deliver his soul from hell.
15 My son, if thine heart be wise, my heart shall rejoice, even mine.
16 Yea, my reins shall rejoice, when thy lips speak right things.
17 Let not thine heart envy sinners: but be thou in the fear of the LORD all the day long.
18 For surely there is an end; and thine expectation shall not be cut off.
19 Hear thou, my son, and be wise, and guide thine heart in the way.
20 Be not among winebibbers; among riotous eaters of flesh:
21 For the drunkard and the glutton shall come to poverty: and drowsiness shall clothe a man with rags.
22 Hearken unto thy father that begat thee, and despise not thy mother when she is old.
23 Buy the truth, and sell it not; also wisdom, and instruction, and understanding.
24 The father of the righteous shall greatly rejoice: and he that begetteth a wise child shall have joy of him.
25 Thy father and thy mother shall be glad, and she that bare thee shall rejoice.
26 My son, give me thine heart, and let thine eyes observe my ways.
27 For a whore is a deep ditch; and a strange woman is a narrow pit.
28 She also lieth in wait as for a prey, and increaseth the transgressors among men.
29 Who hath woe? who hath sorrow? who hath contentions? who hath babbling? who hath wounds without cause? who hath redness of eyes?
30 They that tarry long at the wine; they that go to seek mixed wine.
31 Look not thou upon the wine when it is red, when it giveth his colour in the cup, when it moveth itself aright.
32 At the last it biteth like a serpent, and stingeth like an adder.
33 Thine eyes shall behold strange women, and thine heart shall utter perverse things.
34 Yea, thou shalt be as he that lieth down in the midst of the sea, or as he that lieth upon the top of a mast.
35 They have stricken me, shalt thou say, and I was not sick; they have beaten me, and I felt it not: when shall I awake? I will seek it yet again.`;

const PROVERBS_31_KJV =
`1 The words of king Lemuel, the prophecy that his mother taught him.
2 What, my son? and what, the son of my womb? and what, the son of my vows?
3 Give not thy strength unto women, nor thy ways to that which destroyeth kings.
4 It is not for kings, O Lemuel, it is not for kings to drink wine; nor for princes strong drink:
5 Lest they drink, and forget the law, and pervert the judgment of any of the afflicted.
6 Give strong drink unto him that is ready to perish, and wine unto those that be of heavy hearts.
7 Let him drink, and forget his poverty, and remember his misery no more.
8 Open thy mouth for the dumb in the cause of all such as are appointed to destruction.
9 Open thy mouth, judge righteously, and plead the cause of the poor and needy.
10 Who can find a virtuous woman? for her price is far above rubies.
11 The heart of her husband doth safely trust in her, so that he shall have no need of spoil.
12 She will do him good and not evil all the days of her life.
13 She seeketh wool, and flax, and worketh willingly with her hands.
14 She is like the merchants' ships; she bringeth her food from afar.
15 She riseth also while it is yet night, and giveth meat to her household, and a portion to her maidens.
16 She considereth a field, and buyeth it: with the fruit of her hands she planteth a vineyard.
17 She girdeth her loins with strength, and strengtheneth her arms.
18 She perceiveth that her merchandise is good: her candle goeth not out by night.
19 She layeth her hands to the spindle, and her hands hold the distaff.
20 She stretcheth out her hand to the poor; yea, she reacheth forth her hands to the needy.
21 She is not afraid of the snow for her household: for all her household are clothed with scarlet.
22 She maketh herself coverings of tapestry; her clothing is silk and purple.
23 Her husband is known in the gates, when he sitteth among the elders of the land.
24 She maketh fine linen, and selleth it; and delivereth girdles unto the merchant.
25 Strength and honour are her clothing; and she shall rejoice in time to come.
26 She openeth her mouth with wisdom; and in her tongue is the law of kindness.
27 She looketh well to the ways of her household, and eateth not the bread of idleness.
28 Her children arise up, and call her blessed; her husband also, and he praiseth her.
29 Many daughters have done virtuously, but thou excellest them all.
30 Favour is deceitful, and beauty is vain: but a woman that feareth the LORD, she shall be praised.
31 Give her of the fruit of her hands; and let her own works praise her in the gates.`;

/* =======================
   STATE (in-memory)
======================= */
let dailyLogs = JSON.parse(localStorage.getItem(KEY_DAILY_CACHE)) || [];
let fridayWeighIns = JSON.parse(localStorage.getItem(KEY_WEIGHINS_CACHE)) || [];
let currentScripture = localStorage.getItem(KEY_SCRIPTURE) || "psalm";

/* =======================
   UTIL
======================= */
function escapeHtml(str){
  return (str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function toISODate(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function isFriday(dateStr){
  const d = new Date(dateStr + "T00:00:00");
  return d.getDay() === 5;
}

function sortWeighIns(){
  fridayWeighIns.sort((a,b)=> (a.date > b.date ? 1 : -1));
}

function setDefaultDailyDate(){
  const el = document.getElementById("dailyDate");
  if(!el) return;
  el.value = toISODate(new Date());
}

function setDefaultFridayDate(){
  const el = document.getElementById("fridayDate");
  if(!el) return;
  const today = new Date();
  const d = new Date(today);
  while(d.getDay() !== 5) d.setDate(d.getDate()-1);
  el.value = toISODate(d);
}

function setDefaultBibleLogDate(){
  const el = document.getElementById("bibleLogDate");
  if(!el) return;
  el.value = toISODate(new Date());
}

function scrollToDailyForm(){
  const el = document.getElementById("dailyDate");
  if(!el) return;
  el.scrollIntoView({ behavior: "smooth", block: "start" });
}

function cacheToLocal(){
  localStorage.setItem(KEY_DAILY_CACHE, JSON.stringify(dailyLogs));
  localStorage.setItem(KEY_WEIGHINS_CACHE, JSON.stringify(fridayWeighIns));
}

/* =======================
   UI SHOW/HIDE
======================= */
function showAuth(){
  document.getElementById("authScreen").classList.remove("hidden");
  document.getElementById("appScreen").classList.add("hidden");
  document.getElementById("setupMsg").textContent = "";
  document.getElementById("loginMsg").textContent = "";
}

function showApp(){
  document.getElementById("authScreen").classList.add("hidden");
  document.getElementById("appScreen").classList.remove("hidden");
}

/* =======================
   FIRESTORE PATH HELPERS
======================= */
function dailyCol(){
  return db.collection("users").doc(currentUid).collection("health_daily");
}
function weighCol(){
  return db.collection("users").doc(currentUid).collection("health_friday");
}

/* =======================
   FIREBASE AUTH
======================= */
async function createAccount(){
  const email = (document.getElementById("setupUser").value || "").trim();
  const pass  = (document.getElementById("setupPass").value || "").trim();
  const msg = document.getElementById("setupMsg");
  msg.textContent = "";

  if(!email.includes("@")){
    msg.textContent = "Please enter a valid email.";
    return;
  }
  if(pass.length < 6){
    msg.textContent = "Password must be at least 6 characters.";
    return;
  }

  try{
    await auth.createUserWithEmailAndPassword(email, pass);
    // onAuthStateChanged will handle showing app + syncing
  }catch(e){
    msg.textContent = `Create account failed:\n${e.message || e}`;
  }
}

async function login(){
  const email = (document.getElementById("loginUser").value || "").trim();
  const pass  = (document.getElementById("loginPass").value || "").trim();
  const msg = document.getElementById("loginMsg");
  msg.textContent = "";

  if(!email.includes("@")){
    msg.textContent = "Please enter your email.";
    return;
  }
  if(!pass){
    msg.textContent = "Please enter your password.";
    return;
  }

  try{
    await auth.signInWithEmailAndPassword(email, pass);
  }catch(e){
    msg.textContent = `Login failed:\n${e.message || e}`;
  }
}

async function logout(){
  try{
    if(unsubDaily) { unsubDaily(); unsubDaily = null; }
    if(unsubWeigh) { unsubWeigh(); unsubWeigh = null; }
    currentUid = null;
    await auth.signOut();
  }catch(e){
    alert(e.message || e);
  }
}

function resetLocalCache(){
  const ok = confirm("This clears cached data on THIS device only. Your Firebase cloud data stays safe. Continue?");
  if(!ok) return;
  localStorage.removeItem(KEY_DAILY_CACHE);
  localStorage.removeItem(KEY_WEIGHINS_CACHE);
  dailyLogs = [];
  fridayWeighIns = [];
  renderDailyList();
  renderWeighInList();
  renderWeighInChart();
  renderBibleDates();
  updateKPIs();
}

/* =======================
   LIVE SYNC (Firestore onSnapshot)
======================= */
function startSync(){
  if(!currentUid) return;

  if(unsubDaily) unsubDaily();
  if(unsubWeigh) unsubWeigh();

  unsubDaily = dailyCol().orderBy("date","desc").onSnapshot((snap)=>{
    dailyLogs = snap.docs.map(d=>d.data());
    cacheToLocal();
    syncBibleCheckboxForToday();
    renderDailyList();
    renderBibleDates();
    updateKPIs();
  }, (err)=>{
    console.error(err);
  });

  unsubWeigh = weighCol().orderBy("date","asc").onSnapshot((snap)=>{
    fridayWeighIns = snap.docs.map(d=>d.data());
    cacheToLocal();
    renderWeighInList();
    renderWeighInChart();
    renderMonthlyMilestone(getLatestWeighInDate());
    updateKPIs();
  }, (err)=>{
    console.error(err);
  });
}

/* =======================
   APP INIT
======================= */
function initApp(displayName){
  showApp();

  document.getElementById("helloUser").textContent = `Hi, ${displayName} üíú`;
  document.getElementById("goalSubtitle").textContent =
    `Goal: ${GOAL.startWeight} ‚Üí ${GOAL.targetWeight} by ${GOAL.endDate} | Friday weigh-ins + daily habits`;

  setDefaultDailyDate();
  setDefaultFridayDate();
  setDefaultBibleLogDate();

  if(currentScripture === "proverbs31") showProverbs31();
  else if(currentScripture === "proverbs") showProverbs();
  else showPsalm();

  // Render cached immediately (so it feels fast)
  renderDailyList();
  renderWeighInList();
  renderWeighInChart();
  renderMonthlyMilestone(getLatestWeighInDate());
  renderBibleDates();
  updateKPIs();

  // Then start live sync (cloud)
  startSync();
}

window.addEventListener("load", ()=>{
  showAuth();

  auth.onAuthStateChanged((user)=>{
    if(user){
      currentUid = user.uid;
      initApp(user.email || "Mrs. Starch");
    } else {
      currentUid = null;
      showAuth();
    }
  });
});

/* =======================
   SCRIPTURE TOGGLES
======================= */
function showPsalm(){
  currentScripture = "psalm";
  localStorage.setItem(KEY_SCRIPTURE, currentScripture);
  document.getElementById("scriptureTitle").textContent = "Psalm 23 (KJV)";
  document.getElementById("scriptureText").textContent = PSALM_23_KJV;
}

function showProverbs(){
  currentScripture = "proverbs";
  localStorage.setItem(KEY_SCRIPTURE, currentScripture);
  document.getElementById("scriptureTitle").textContent = "Proverbs 23 (KJV)";
  document.getElementById("scriptureText").textContent = PROVERBS_23_KJV;
}

function showProverbs31(){
  currentScripture = "proverbs31";
  localStorage.setItem(KEY_SCRIPTURE, currentScripture);
  document.getElementById("scriptureTitle").textContent = "Proverbs 31 (KJV)";
  document.getElementById("scriptureText").textContent = PROVERBS_31_KJV;
}

/* =======================
   FIRESTORE WRITE HELPERS
======================= */
async function upsertDaily(entry){
  if(!currentUid){ alert("Please login first."); return; }
  await dailyCol().doc(entry.date).set(entry, { merge: true });
}

async function deleteDailyDoc(date){
  if(!currentUid){ alert("Please login first."); return; }
  await dailyCol().doc(date).delete();
}

async function upsertWeigh(entry){
  if(!currentUid){ alert("Please login first."); return; }
  await weighCol().doc(entry.date).set(entry, { merge: true });
}

async function deleteWeighDoc(date){
  if(!currentUid){ alert("Please login first."); return; }
  await weighCol().doc(date).delete();
}

/* =======================
   BIBLE DATES LOG (SYNC)
======================= */
async function saveBibleLog(){
  const date = (document.getElementById("bibleLogDate").value || "").trim();
  const note = (document.getElementById("bibleLogNote").value || "").trim();
  if(!date){ alert("Please pick a date."); return; }

  // base from existing daily record if present
  const existing = dailyLogs.find(d=>d.date===date) || {
    date,
    workout: false,
    foodOnPlan: false,
    journal: "",
    bibleRead: false,
    workoutText: "",
    calories: null,
    meals: "",
    water40plus: false
  };

  const updated = {
    ...existing,
    date,
    bibleRead: true,
    bibleNote: note || (existing.bibleNote || "")
  };

  try{
    await upsertDaily(updated);

    const today = toISODate(new Date());
    if(date === today){
      const bible = document.getElementById("bibleRead");
      if(bible) bible.checked = true;
    }

    document.getElementById("bibleLogNote").value = "";
  }catch(e){
    alert(e.message || e);
  }
}

function getBibleReadDatesSortedAsc(){
  const dates = dailyLogs
    .filter(d => d && d.date && d.bibleRead === true)
    .map(d => d.date);

  const uniq = Array.from(new Set(dates));
  uniq.sort((a,b)=> (a > b ? 1 : -1));
  return uniq;
}

function calcBibleStreak(){
  const datesAsc = getBibleReadDatesSortedAsc();
  if(datesAsc.length === 0) return 0;

  const set = new Set(datesAsc);
  let streak = 0;
  let cur = new Date(toISODate(new Date()) + "T00:00:00");

  while(true){
    const key = toISODate(cur);
    if(set.has(key)){
      streak++;
      cur.setDate(cur.getDate()-1);
    } else break;
  }
  return streak;
}

function renderBibleDates(){
  const listEl = document.getElementById("bibleDatesList");
  const streakEl = document.getElementById("bibleStreakPill");
  const totalEl = document.getElementById("bibleTotalPill");
  if(!listEl || !streakEl || !totalEl) return;

  const datesAsc = getBibleReadDatesSortedAsc();
  const total = datesAsc.length;
  const streak = calcBibleStreak();

  streakEl.textContent = `Streak: ${streak} day${streak===1?"":"s"}`;
  totalEl.textContent = `Total dates logged: ${total}`;

  if(total === 0){
    listEl.innerHTML = `<div class="small">No dates yet. Log today to start your streak üíú</div>`;
    return;
  }

  const datesDesc = datesAsc.slice().reverse().slice(0,10);
  listEl.innerHTML = datesDesc.map(date=>{
    const rec = dailyLogs.find(d=>d.date===date);
    const note = rec && rec.bibleNote ? rec.bibleNote.trim() : "";
    return `
      <div class="listItem">
        <div class="meta">${date} ‚Äî üìñ Read</div>
        ${note ? `<div class="note">${escapeHtml(note)}</div>` : `<div class="small">No note.</div>`}
        <div class="actions">
          <button class="btn light" onclick="editBibleDate('${date}')">Edit</button>
          <button class="btn secondary" onclick="deleteBibleDate('${date}')">Remove</button>
        </div>
      </div>
    `;
  }).join("");
}

function editBibleDate(date){
  const rec = dailyLogs.find(d=>d.date===date);
  document.getElementById("bibleLogDate").value = date;
  document.getElementById("bibleLogNote").value = (rec && rec.bibleNote) ? rec.bibleNote : "";
  window.scrollTo({ top: 0, behavior: "smooth" });
}

async function deleteBibleDate(date){
  const ok = confirm("Remove Bible-read mark for this date?");
  if(!ok) return;

  const d = dailyLogs.find(x=>x.date===date);
  if(!d) return;

  const hasOtherData =
    (d.workout === true) ||
    (d.foodOnPlan === true) ||
    (d.water40plus === true) ||
    (typeof d.calories === "number" && d.calories !== null) ||
    (d.meals && d.meals.trim() !== "") ||
    (d.workoutText && d.workoutText.trim() !== "") ||
    (d.journal && d.journal.trim() !== "");

  try{
    if(hasOtherData){
      await upsertDaily({ ...d, bibleRead: false, bibleNote: "" });
    } else {
      await deleteDailyDoc(date);
    }

    const today = toISODate(new Date());
    if(date === today){
      const bible = document.getElementById("bibleRead");
      if(bible) bible.checked = false;
    }
  }catch(e){
    alert(e.message || e);
  }
}

/* =======================
   DAILY CHECK-IN (SYNC + EDIT/DELETE)
======================= */
function syncBibleCheckboxForToday(){
  const today = toISODate(new Date());
  const log = dailyLogs.find(d=>d.date===today);
  const bible = document.getElementById("bibleRead");
  if(!bible) return;
  bible.checked = !!(log && log.bibleRead);
}

function clearDailyForm(){
  setDefaultDailyDate();
  document.getElementById("dailyWorkout").checked = false;
  document.getElementById("dailyFood").checked = false;
  document.getElementById("dailyWorkoutText").value = "";
  document.getElementById("dailyCalories").value = "";
  document.getElementById("dailyMeals").value = "";
  document.getElementById("dailyWater40").checked = false;
  document.getElementById("dailyJournal").value = "";
  document.getElementById("dailyMsg").textContent = "";
}

async function saveDaily(){
  const date = (document.getElementById("dailyDate").value || "").trim();
  if(!date){ return; }
  if(!currentUid){ alert("Please login first."); return; }

  const caloriesRaw = parseInt(document.getElementById("dailyCalories").value, 10);
  const caloriesVal = Number.isFinite(caloriesRaw) ? caloriesRaw : null;

  const existing = dailyLogs.find(d=>d.date===date) || {};

  const entry = {
    ...existing,
    date,
    workout: !!document.getElementById("dailyWorkout").checked,
    foodOnPlan: !!document.getElementById("dailyFood").checked,
    journal: (document.getElementById("dailyJournal").value || "").trim(),
    bibleRead: !!document.getElementById("bibleRead").checked,

    workoutText: (document.getElementById("dailyWorkoutText").value || "").trim(),
    calories: caloriesVal,
    meals: (document.getElementById("dailyMeals").value || "").trim(),
    water40plus: !!document.getElementById("dailyWater40").checked
  };

  try{
    await upsertDaily(entry);

    const msg = document.getElementById("dailyMsg");
    msg.textContent = "Saved to cloud. You showed up today üíú";

    document.getElementById("dailyWorkoutText").value = "";
    document.getElementById("dailyCalories").value = "";
    document.getElementById("dailyMeals").value = "";
    document.getElementById("dailyWater40").checked = false;
    document.getElementById("dailyJournal").value = "";
  }catch(e){
    alert(e.message || e);
  }
}

function editDaily(date){
  const rec = dailyLogs.find(d=>d.date===date);
  if(!rec) return;

  document.getElementById("dailyDate").value = rec.date;
  document.getElementById("dailyWorkout").checked = !!rec.workout;
  document.getElementById("dailyFood").checked = !!rec.foodOnPlan;

  document.getElementById("dailyWorkoutText").value = rec.workoutText || "";
  document.getElementById("dailyCalories").value = (typeof rec.calories === "number") ? String(rec.calories) : "";
  document.getElementById("dailyMeals").value = rec.meals || "";
  document.getElementById("dailyWater40").checked = !!rec.water40plus;

  document.getElementById("dailyJournal").value = rec.journal || "";

  const today = toISODate(new Date());
  if(rec.date === today){
    const bible = document.getElementById("bibleRead");
    if(bible) bible.checked = !!rec.bibleRead;
  }

  document.getElementById("dailyMsg").textContent = `Editing ${rec.date} (make changes then click Save)`;
  scrollToDailyForm();
}

async function deleteDaily(date){
  const ok = confirm(`Delete daily check-in for ${date}?`);
  if(!ok) return;

  try{
    await deleteDailyDoc(date);

    if(document.getElementById("dailyDate").value === date){
      clearDailyForm();
    }
  }catch(e){
    alert(e.message || e);
  }
}

function renderDailyList(){
  const wrap = document.getElementById("dailyList");
  if(!wrap) return;

  if(dailyLogs.length === 0){
    wrap.innerHTML = `<div class="small">No daily logs yet. Start with today.</div>`;
    return;
  }

  const items = dailyLogs.slice(0,10).map(d=>{
    const checks = [
      d.bibleRead ? "‚úùÔ∏è Bible" : null,
      d.workout ? "üèÉ Move" : null,
      d.foodOnPlan ? "üçΩ On plan" : null,
      d.water40plus ? "üíß 40oz+" : null,
      d.meals ? `üçΩ ${d.meals}` : null,
      (typeof d.calories === "number") ? `üî• ${d.calories} cal` : null
    ].filter(Boolean).join(" ‚Ä¢ ");

    const bibleNote = (d.bibleRead && d.bibleNote && d.bibleNote.trim())
      ? `<div class="note">Bible note: ${escapeHtml(d.bibleNote)}</div>`
      : "";

    return `
      <div class="listItem">
        <div class="meta">${d.date}${checks ? " ‚Äî " + checks : ""}</div>
        ${bibleNote}
        ${d.workoutText ? `<div class="note">Workout: ${escapeHtml(d.workoutText)}</div>` : ``}
        ${d.journal ? `<div class="note">${escapeHtml(d.journal)}</div>` : `<div class="small">No journal note.</div>`}

        <div class="actions">
          <button class="btn light" onclick="editDaily('${d.date}')">Edit</button>
          <button class="btn secondary" onclick="deleteDaily('${d.date}')">Delete</button>
        </div>
      </div>
    `;
  }).join("");

  wrap.innerHTML = items;
}

/* =======================
   FRIDAY WEIGH-INS (SYNC)
======================= */
function getLatestWeighInDate(){
  if(fridayWeighIns.length === 0) return null;
  sortWeighIns();
  return fridayWeighIns[fridayWeighIns.length - 1].date;
}

async function saveFridayWeighIn(){
  const date = (document.getElementById("fridayDate").value || "").trim();
  const w = parseFloat(document.getElementById("fridayWeight").value);
  const prayer = (document.getElementById("fridayPrayer").value || "").trim();

  if(!date){ alert("Please choose a date."); return; }
  if(!Number.isFinite(w) || w <= 0){ alert("Please enter a valid weight."); return; }
  if(!currentUid){ alert("Please login first."); return; }

  if(!isFriday(date)){
    const ok = confirm("That date is not a Friday. Save anyway?");
    if(!ok) return;
  }

  const entry = { date, weight: w, prayer };

  try{
    await upsertWeigh(entry);
    document.getElementById("fridayWeight").value = "";
    document.getElementById("chartHint").textContent = "Saved to cloud. Weekly data > daily emotions üíú";
  }catch(e){
    alert(e.message || e);
  }
}

function renderWeighInList(){
  const wrap = document.getElementById("weighInList");
  if(!wrap) return;

  if(fridayWeighIns.length === 0){
    wrap.innerHTML = `<div class="small">No weigh-ins yet. Start this Friday üíú</div>`;
    return;
  }

  const reversed = fridayWeighIns.slice().reverse();
  wrap.innerHTML = reversed.map(w=>{
    return `
      <div class="listItem">
        <div class="meta">${w.date} ‚Äî ${w.weight} lbs</div>
        ${w.prayer ? `<div class="note">${escapeHtml(w.prayer)}</div>` : `<div class="small">No prayer/reflection.</div>`}
        <div class="actions">
          <button class="btn light" onclick="editWeighIn('${w.date}')">Edit</button>
          <button class="btn secondary" onclick="deleteWeighIn('${w.date}')">Delete</button>
        </div>
      </div>
    `;
  }).join("");
}

function editWeighIn(date){
  const found = fridayWeighIns.find(w=>w.date===date);
  if(!found) return;
  document.getElementById("fridayDate").value = found.date;
  document.getElementById("fridayPrayer").value = found.prayer || "";
  document.getElementById("fridayWeight").value = found.weight;
  window.scrollTo({ top: 0, behavior: "smooth" });
}

async function deleteWeighIn(date){
  const ok = confirm("Delete this weigh-in?");
  if(!ok) return;
  try{
    await deleteWeighDoc(date);
  }catch(e){
    alert(e.message || e);
  }
}

function renderWeighInChart(){
  const canvas = document.getElementById("weighInChart");
  const hint = document.getElementById("chartHint");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const padding = 40, W = canvas.width, H = canvas.height;

  ctx.strokeStyle = "rgba(46,26,71,0.18)";
  ctx.lineWidth = 1;
  ctx.strokeRect(padding, padding, W-padding*2, H-padding*2);

  ctx.strokeStyle = "rgba(46,26,71,0.08)";
  for(let i=1;i<=3;i++){
    const y = padding + i*(H - padding*2)/4;
    ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(W-padding, y); ctx.stroke();
  }

  if(fridayWeighIns.length < 2){
    if(hint) hint.textContent = "Add at least 2 weigh-ins to see a line.";
    return;
  }

  sortWeighIns();
  const weights = fridayWeighIns.map(x=>x.weight);
  const minW = Math.min(...weights);
  const maxW = Math.max(...weights);
  const range = Math.max(5, maxW - minW);
  const yMin = minW - range*0.15;
  const yMax = maxW + range*0.15;

  ctx.fillStyle = "rgba(46,26,71,0.9)";
  ctx.font = "12px Arial";
  ctx.fillText(`${Math.round(yMax)} lbs`, 8, padding-10);
  ctx.fillText(`${Math.round(yMin)} lbs`, 8, H - 10);

  ctx.strokeStyle = "rgba(123, 74, 226, 0.95)";
  ctx.lineWidth = 3;
  ctx.beginPath();

  fridayWeighIns.forEach((pt, i)=>{
    const x = padding + (i*(W - padding*2)) / (fridayWeighIns.length - 1);
    const y = padding + ((yMax - pt.weight) * (H - padding*2)) / (yMax - yMin);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();

  ctx.fillStyle = "rgba(46,26,71,0.9)";
  fridayWeighIns.forEach((pt, i)=>{
    const x = padding + (i*(W - padding*2)) / (fridayWeighIns.length - 1);
    const y = padding + ((yMax - pt.weight) * (H - padding*2)) / (yMax - yMin);
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
  });

  const latest = fridayWeighIns[fridayWeighIns.length - 1];
  const change = (GOAL.startWeight - latest.weight);
  if(hint) hint.textContent = `Start: ${GOAL.startWeight} ‚Üí Latest: ${latest.weight} (Change: ${change.toFixed(1)} lbs)`;
}

function renderMonthlyMilestone(referenceDateStr){
  const box = document.getElementById("milestoneText");
  if(!box) return;

  const latestDate = referenceDateStr || getLatestWeighInDate();
  if(!latestDate){
    box.innerHTML = `<div class="small">No weigh-ins yet. Your journey still counts üíú</div>`;
    return;
  }

  const latest = fridayWeighIns.find(w=>w.date===latestDate) || fridayWeighIns[fridayWeighIns.length-1];
  const target = getTargetWeightForMonth(latest.date);
  const diff = latest.weight - target;

  const direction = diff <= 0
    ? `You‚Äôre <strong>${Math.abs(diff).toFixed(1)} lbs</strong> ahead of this month‚Äôs target.`
    : `You‚Äôre <strong>${diff.toFixed(1)} lbs</strong> above this month‚Äôs target (still okay‚Äîfocus on habits).`;

  box.innerHTML = `
    <div><strong>Month target:</strong> ${target.toFixed(1)} lbs</div>
    <div style="margin-top:8px;">${direction}</div>
    <div class="small" style="margin-top:10px;">
      Proverbs 23:18 ‚Äî ‚ÄúFor surely there is an end; and thine expectation shall not be cut off.‚Äù
    </div>
  `;
}

function getTargetWeightForMonth(dateStr){
  const startD = new Date(GOAL.startDate + "T00:00:00");
  const endD   = new Date(GOAL.endDate + "T00:00:00");
  const d      = new Date(dateStr + "T00:00:00");

  const monthEnd = new Date(d.getFullYear(), d.getMonth()+1, 0);
  const clampMs = Math.min(Math.max(monthEnd.getTime(), startD.getTime()), endD.getTime());

  const totalMs = endD - startD;
  const doneMs  = clampMs - startD.getTime();
  const t = totalMs <= 0 ? 1 : Math.min(1, Math.max(0, doneMs / totalMs));

  return GOAL.startWeight + (GOAL.targetWeight - GOAL.startWeight) * t;
}

/* =======================
   KPIs
======================= */
function updateKPIs(){
  document.getElementById("kpiStartGoal").textContent = `${GOAL.startWeight} ‚Üí ${GOAL.targetWeight}`;
  document.getElementById("kpiDaysLogged").textContent = String(dailyLogs.length);

  if(fridayWeighIns.length === 0){
    document.getElementById("kpiLatestFriday").textContent = "‚Äî";
    document.getElementById("kpiTotalChange").textContent = "‚Äî";
    return;
  }

  sortWeighIns();
  const latest = fridayWeighIns[fridayWeighIns.length - 1];
  document.getElementById("kpiLatestFriday").textContent = `${latest.weight} lbs`;

  const change = (GOAL.startWeight - latest.weight);
  const sign = change >= 0 ? "-" : "+";
  document.getElementById("kpiTotalChange").textContent = `${sign}${Math.abs(change).toFixed(1)} lbs`;
}
</script>

</body>
</html>
